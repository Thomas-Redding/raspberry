<meta charset="utf-8">
<style>
html {
  color: white;
  overflow: hidden;
  background-color: #222;
}
#container {
  position: absolute;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  overflow-x: scroll;
}
table {
  display: block;
  overflow: hidden;
  height: 100vh;
  border-collapse: collapse;
}
tbody {
  display: block;
  height: 100vh;
}
tr {
  display: block;
  height: 100vh;
}
td {
  width: 12em;
  vertical-align: top;
}
td > div {
  height: 100vh;
  overflow-y: scroll;
}
.file {
  overflow-x: scroll;
  line-height: 1.4em;
}
.selected {
  background-color: hsl(240, 100%, 40%);
}
a {
  color: hsl(50, 100%, 50%);
}
</style>
<script>
let FILE_INDEX = <JSON_INDEX_DATA>;
</script>
<script>
function navigateToPath() {
  let td = document.createElement("TD");
  containingRow.append(td);
  let columnDiv = document.createElement("div");
  for (let i = 0; i < FILE_INDEX[""].length; ++i) {
    let fileName = FILE_INDEX[""][i];
    let file = document.createElement("div");
    file.classList.add("file");
    if (!(fileName in FILE_INDEX)) {
      let a = document.createElement("a");
      a.href = "/@/" + completePath;
      file.append(a);
      a.innerHTML = FILE_INDEX[fileName][i];
    } else {
      file.innerHTML = FILE_INDEX[fileName][i];
    }
    columnDiv.append(file);
    td.append(columnDiv);
  }
};

function selectionIndexPath() {
  let rtn = [];
  for (let i = 0; i < containingRow.children.length; ++i) {
    let cell = containingRow.children[i];
    for (let j = 0; j < cell.children[0].children.length; ++j) {
      if (cell.children[0].children[j].classList.contains("selected")) {
        rtn.push(j);
      }
    }
  }
  return rtn;
}

function filePathFromIndexPath(indexPath) {
  let rtn = [];
  for (let i = 0; i < indexPath.length; ++i) {
    let cell = containingRow.children[i];
    rtn.push(cell.children[0].children[indexPath[i]].innerText);
  }
  return rtn.join("/");
}

function fileDiv(parentPath, fileName) {
  let totalPath = parentPath + "/" + fileName;
  if (parentPath == "") totalPath = fileName;
  let file = document.createElement("DIV");
  file.classList.add("file");
  if (totalPath in FILE_INDEX) {
    file.innerHTML = fileName;
  } else {
    let a = document.createElement("A");
    a.href = "/@/" + totalPath;
    a.innerHTML = fileName;
    file.append(a);
  }
  return file;
}

onkeydown = (event) => {
  event.preventDefault();
  if (event.keyCode == 37) {
    // left
    let indexPath = selectionIndexPath()
    let filePath = filePathFromIndexPath(indexPath);
    if (filePath in FILE_INDEX) {
      // The leaf is a directory.
      let lastCell = containingRow.children[containingRow.children.length - 1];
      containingRow.removeChild(lastCell);
    }
    let lastCell = containingRow.children[containingRow.children.length - 1];
    lastCell.children[0].children[indexPath[indexPath.length - 1]].classList.remove("selected");
  } else if (event.keyCode == 39) {
    let lastCell = containingRow.children[containingRow.children.length - 1];
    lastCell.children[0].children[0].classList.add("selected");
    let s = selectionIndexPath();
    let filePath = filePathFromIndexPath(s);
    if (!(filePath in FILE_INDEX)) {
      // The leaf is a file
      return;
    }
    let children = FILE_INDEX[filePath];
    let td = document.createElement("TD");
    let div = document.createElement("DIV");
    for (let i = 0; i < children.length; ++i) {
      div.append(fileDiv(filePath, children[i]));
    }
    td.append(div);
    containingRow.append(td);
  } else if (event.keyCode == 38 || event.keyCode == 40) {
    // up or down
    let isUp = (event.keyCode == 38);
    let indexPath = selectionIndexPath()
    let filePath = filePathFromIndexPath(indexPath);
    let selectedCell = containingRow.children[indexPath.length - 1];
    let fileContainer = selectedCell.children[0];
    if (filePath in FILE_INDEX) {
      // The original leaf is a directory. Close it.
      let lastCell = containingRow.children[containingRow.children.length - 1];
      containingRow.removeChild(lastCell);
    }
    let selectedRow = indexPath[indexPath.length - 1];
    if (isUp) {
      if (selectedRow == 0) return;
      fileContainer.children[selectedRow-1].classList.add("selected");
    } else {
      if (selectedRow + 1 == fileContainer.children.length) return;
      fileContainer.children[selectedRow+1].classList.add("selected");
    }
    fileContainer.children[selectedRow].classList.remove("selected");
    fileContainer.scrollTo(0, fileContainer.children[selectedRow].offsetTop - 100);
    indexPath = selectionIndexPath()
    filePath = filePathFromIndexPath(indexPath);
    if (filePath in FILE_INDEX) {
      // The leaf is a directory. Open it.
      let td = document.createElement("TD");
      let div = document.createElement("DIV");
      let children = FILE_INDEX[filePath];
      for (let i = 0; i < children.length; ++i) {
        div.append(fileDiv(filePath, children[i]));
      }
      td.append(div);
      containingRow.append(td);
      return;
    }
  }
};

onload = () => {
  let td = document.createElement("TD");
  let div = document.createElement("DIV");
  let children = FILE_INDEX[""];
  for (let i = 0; i < children.length; ++i) {
    div.append(fileDiv("", children[i]));
  }
  td.append(div);
  containingRow.append(td);
};
</script>
<div id="container">
  <table>
    <tbody>
      <tr id="containingRow"></tr>
    </tbody>
  </table>
</div>
