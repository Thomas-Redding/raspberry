
<!DOCTYPE html>
<html>
<head>
<style>
html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  background-color: #222;
  color: white;
  padding: 0;
  margin: 0;
}

#bodyDiv {
  display: flex;
  flex-direction: column;
  padding: 0;
  margin: 0;
  width: 100%;
  height: 100%;
}

a {
  color: #79f;
  text-decoration: underline;
  cursor: pointer;
}

#container {
  flex: 1;
  display: flex;
  flex-direction: row;
  border-top: solid white 1px;
}

#topBarDiv {
  padding: 0.2em;
}

#leftBarDiv {
  border-right: solid white 1px;
  min-width: 96px;
  padding: 0.2em;
}

#mainVideo {
  max-height: 100%;
  max-width: 100%;
  height: 100vh;
}

#videoDiv {
  flex: 1;
  position: relative;
}

</style>
<script>

const FILE_INDEX = <JSON_INDEX_DATA>;

window.onresize = () => {
  let pad = 0;
  let rect = bodyDiv.getBoundingClientRect();
  let trect = topBarDiv.getBoundingClientRect();
  rect.width -= pad;
  rect.height -= pad + trect.height;
  let r = mainVideo.videoWidth / mainVideo.videoHeight;
  if (rect.width / rect.height > r) {
    let h = rect.height;
    mainVideo.style.height = Math.floor(h) + 'px';
    mainVideo.style.width = Math.floor(h * r) + 'px';
  } else {
    let w = rect.width;
    mainVideo.style.width = Math.floor(w) + 'px';
    mainVideo.style.height = Math.floor(w / r) + 'px';
  }
  console.log(mainVideo.videoWidth);
  //mainVideo.style.width = rect.width + 'px';
  //mainVideo.style.height = rect.height + 'px';
  //console.log(mainVideo);
}

Array.prototype.back = function() {
  return this[this.length - 1];
}

let currentLocation = ['videos']

function update_top_bar() {
  let url = '';
  let lines = [];
  for (let dir of currentLocation) {
    url += dir;
    let line = '<a onclick="onlinkclick(\'' + url + '\')">' + dir + '</a>';
    url += '/';
    lines.push(line);
  }

  topBarDiv.innerHTML = lines.join('/');

  //topBarDiv.innerHTML = currentLocation.map(x => '<a href="">' + x + '</a>').join('/');
}

function onlinkclick(abspath, time) {
  if (abspath.endsWith('.mp4')) {
    mainVideo.src = '@/' + abspath;
    if (time !== undefined) {
      let fn = () => {
        mainVideo.currentTime = time;
        mainVideo.removeEventListener('canplay', fn);
      };
      mainVideo.addEventListener('canplay', fn);
    }
  }

  currentLocation = abspath.split('/');
  update_top_bar();
  update_left_bar();
}

const kBadFormats = ['.avi', '.AVI', '.m4v', '.mkv', '.mht', '.mKV', '.wmv']

function update_left_bar() {
  let loc = currentLocation;

  // If the location isn't found, it's probably because it's a video file,
  // so we pop it off to get the parent directory.
  if (!(loc.join('/') in FILE_INDEX)) {
    loc = loc.slice();  // copy
    loc.pop();
  }

  let lines = [];
  for (let filename of FILE_INDEX[loc.join('/')]) {
    let bad = false;
    for (let format of kBadFormats) {
      if (filename.endsWith(format)) {
        bad = true;
      }
    }
    if (bad) {
      continue;
    }
    let abspath = loc.join('/') + '/' + filename;
    lines.push('<a onclick="onlinkclick(\'' + abspath + '\')">' + filename + '</a>');
  }
  leftBarDiv.innerHTML = lines.join('<br>');
}

function url2json(url) {
  if (!url.includes('?')) return {}
  let parts = url.split('?')[1].split('&');
  let r = {}
  for (let part of parts) {
    let a = part.split('=');
    r[a[0]] = decodeURIComponent(a[1]);
  }
  return r;
}

window.onload = () => {
  console.log('onload');
  mainVideo.addEventListener('canplay', () => {
    window.onresize();
  });

  let urlParams = url2json(window.location.href);
  let time = 0;
  if ('path' in urlParams) {
   currentLocation = urlParams['path'].split('/');
  }
  if ('time' in urlParams) {
    time = urlParams['time'];
  }
  onlinkclick(currentLocation.join('/'), time);
  window.onresize();
}

function text2clipboard(txt) {
  let a = document.createElement('TEXTAREA');
  a.value = txt;
  document.body.appendChild(a);
  a.select();
  document.execCommand('copy');
  document.body.removeChild(a);
}

function link2clipboard(includeTime) {
  let path = encodeURIComponent(currentLocation.join('/'));
  let time = mainVideo.currentTime;
  if (includeTime) {
    text2clipboard('10.0.0.241:8080/?path=' + path +'&time=' + time);
  } else {
    text2clipboard('10.0.0.241:8080/?path=' + path);
  }
}

function embiggen() {
  if (leftBarDiv.style.display != 'none') {
    leftBarDiv.style.display = 'none';
  } else {
    leftBarDiv.style.display = 'block';
  }
}

</script>
</head>
<body>
<div id='bodyDiv'>
  <div style='display:flex; flex-direction:row'>
    <div>
      <div id='topBarDiv' style='display:inline-block'></div>
      <button onclick='link2clipboard(false)'>Copy Link</button>
      <button onclick='link2clipboard(true)'>Copy Link @ Time</button>
      <button onclick='embiggen()' id='embiggenButton'>Embiggen</button>
    </div>
  </div>
  <div id='container'>
    <div id='leftBarDiv'></div>
    <div id='videoDiv'>
      <video id='mainVideo' controls autoplay></video>
    </div>
  </div>
</div>
</body>
</html>
